@model FlippParser.Code.FlippSearchResult
@{
    ViewData["Title"] = "Search Results";
}
<style>
    .paginationControls {
    background: aliceblue;
    padding: 0.2em;
}
    </style>
<div class="container mt-4 mb-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-body">
                    <h1 class="card-title mb-3">@ViewData["Title"]</h1>
                    <div class="mb-3 float-end">
                        <a href="/" class="btn btn-link p-0">&larr; Back to Search</a>
                    </div>
                    <div class="mb-3">
                        <span class="fw-bold">Search Parameters:</span>
                        <ul class="list-inline mb-0">
                            <li class="list-inline-item me-3"><span class="text-secondary">Postal Code:</span> <span
                                class="fw-semibold">@Model.SearchParams?.PostalCode</span></li>
                                <li class="list-inline-item me-3"><span class="text-secondary">Query:</span> <span
                                    class="fw-semibold">@Model.SearchParams?.Query</span></li>
                                </ul>
                            </div>

                            @if (Model == null)
                            {
                                <div class="alert alert-warning">No search results to display.</div>
                            }
                            else if (Model.IsError)
                            {
                                <div class="alert alert-danger">@Model.ErrorMessage</div>
                            }
                            else if (Model.items?.Any() != true)
                            {
                                <div class="alert alert-info">No items found.</div>
                            }
                            else
                            {
                                <div class="mb-3 d-flex flex-wrap align-items-center gap-2">
                                    <label for="filterInput" class="form-label mb-0">Filter results:</label>
                                    <input type="text" id="filterInput" placeholder="Type to filter..." onkeyup="filterTable()"
                                           class="form-control" style="max-width:300px;display:inline-block;" />
                                    <button class="btn btn-outline-primary ms-2" id="toggleViewBtn" onclick="toggleView()">Card View</button>
                                </div>
                                <div class="paginationControls" style="text-align: center;" class="mb-3"></div>
                                <div id="tableView" class="table-responsive rounded shadow-sm">
                                    <table class="table table-striped table-hover align-middle mb-0" id="resultsTable">
                                        <thead class="table-light">
                                            <tr>
                                                <th style="cursor:pointer;" onclick="sortTable(0)">Name</th>
                                                <th style="cursor:pointer;" onclick="sortTable(1)">Merchant</th>
                                                <th style="cursor:pointer;" onclick="sortTable(2)">Current Price</th>
                                                <th style="cursor:pointer;" onclick="sortTable(3)">Original Price</th>
                                                <th style="cursor:pointer;" onclick="sortTable(4)">Sale Story</th>
                                                <th style="cursor:pointer;" onclick="sortTable(5)">Valid From</th>
                                                <th style="cursor:pointer;" onclick="sortTable(6)">Valid To</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var item in Model.items)
                                            {
                                                <tr>
                                                    <td>@item.name</td>
                                                    <td>@item.merchant_name</td>
                                                    <td>@item.current_price</td>
                                                    <td>@item.original_price</td>
                                                    <td>@item.sale_story</td>
                                                    <td>@DateTime.Parse(item.valid_from).ToLongDateString()</td>
                                                    <td>@DateTime.Parse(item.valid_to).ToLongDateString()</td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                                <div id="cardView" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4" style="display:none;">
                                    @foreach (var item in Model.items)
                                    {
                                        <div class="col cardViewItem">
                                            <div class="card h-100 shadow-sm">
                                                <div class="card-body">
                                                    <div class="text-center mb-3">
                                                        <img src="@item.merchant_logo" alt="@item.merchant_name" class="img-fluid rounded mb-2" style="max-height:3em;object-fit:contain;">
                                                        <h5 class="card-title">@item.name</h5>
                                                        <h6 class="card-subtitle mb-2 text-muted"> @item.merchant_name</h6>
                                                        <img src="@item.clean_image_url" alt="@item.name" class="img-fluid rounded mb-2" style="max-height:150px;object-fit:contain;">
                                                    </div>
                                                    <p class="card-text mb-1"><strong>Current Price:</strong> @item.current_price</p>
                                                    <p class="card-text mb-1"><strong>Original Price:</strong> @item.original_price</p>
                                                    <p class="card-text mb-1"><strong>Sale Story:</strong> @item.sale_story</p>
                                                    <p class="card-text mb-1"><strong>Valid From:</strong> @DateTime.Parse(item.valid_from).ToLongDateString()</p>
                                                    <p class="card-text mb-1"><strong>Valid To:</strong> @DateTime.Parse(item.valid_to).ToLongDateString()</p>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                </div>
                                <div class="paginationControls" style="text-align: center;" class="mb-3"></div>
                                <script>
                                // Pagination settings
                                const pageSize = 10;
                                let currentPage = 1;
                                let filteredRows = [];
                                let filteredCards = [];
                                let isCardView = false;
                                let sortDirection = {};

                                function sortTable(n) {
                                    const table = document.getElementById("resultsTable");
                                    const tbody = table.tBodies[0];
                                    const rows = Array.from(tbody.rows);
                                    let dir = sortDirection[n] === "desc" ? "asc" : "desc";
                                    sortDirection[n] = dir;
                                    rows.sort((a, b) => {
                                        let x = a.cells[n].textContent.trim();
                                        let y = b.cells[n].textContent.trim();
                                        let xNum = parseFloat(x.replace(/[^0-9.\-]/g, ""));
                                        let yNum = parseFloat(y.replace(/[^0-9.\-]/g, ""));
                                        let isNumeric = !isNaN(xNum) && !isNaN(yNum);
                                        if (isNumeric) {
                                            return dir === "asc" ? xNum - yNum : yNum - xNum;
                                        } else {
                                            return dir === "asc" ? x.localeCompare(y) : y.localeCompare(x);
                                        }
                                    });
                                    rows.forEach(row => tbody.appendChild(row));
                                    currentPage = 1;
                                    updatePagination();
                                }

                                function filterTable() {
                                    currentPage = 1;
                                    updatePagination();
                                }

                                function updatePagination() {
                                    if (isCardView) {
                                        const cards = Array.from(document.getElementsByClassName("cardViewItem"));
                                        const input = document.getElementById("filterInput");
                                        const filter = input ? input.value.toLowerCase() : "";
                                        filteredCards = cards.filter(card => card.textContent.toLowerCase().indexOf(filter) > -1);
                                        cards.forEach(card => card.style.display = "none");
                                        const start = (currentPage - 1) * pageSize;
                                        const end = start + pageSize;
                                        filteredCards.slice(start, end).forEach(card => card.style.display = "");
                                        renderPaginationControls(filteredCards.length);
                                    } else {
                                        const table = document.getElementById("resultsTable");
                                        const tbody = table.tBodies[0];
                                        const input = document.getElementById("filterInput");
                                        const filter = input ? input.value.toLowerCase() : "";
                                        const allRows = Array.from(tbody.rows);
                                        filteredRows = allRows.filter(row => row.textContent.toLowerCase().indexOf(filter) > -1);
                                        allRows.forEach(row => row.style.display = "none");
                                        const start = (currentPage - 1) * pageSize;
                                        const end = start + pageSize;
                                        filteredRows.slice(start, end).forEach(row => row.style.display = "");
                                        renderPaginationControls(filteredRows.length);
                                    }
                                }

                                function renderPaginationControls(totalItems) {
                                    const controlsList = document.getElementsByClassName("paginationControls");
                                    const totalPages = Math.ceil(totalItems / pageSize) || 1;
                                    let html = '';
                                    if (totalPages > 1) {
                                        html += `<button class='btn btn-sm btn-secondary' onclick='gotoPage(1)' ${currentPage === 1 ? "disabled" : ""}>&laquo; First</button> `;
                                        html += `<button class='btn btn-sm btn-secondary' onclick='gotoPage(${currentPage - 1})' ${currentPage === 1 ? "disabled" : ""}>&lsaquo; Prev</button> `;
                                        html += ` Page ${currentPage} of ${totalPages} `;
                                        html += `<button class='btn btn-sm btn-secondary' onclick='gotoPage(${currentPage + 1})' ${currentPage === totalPages ? "disabled" : ""}>Next &rsaquo;</button> `;
                                        html += `<button class='btn btn-sm btn-secondary' onclick='gotoPage(${totalPages})' ${currentPage === totalPages ? "disabled" : ""}>Last &raquo;</button>`;
                                    }
                                    for (let i = 0; i < controlsList.length; i++) {
                                        controlsList[i].innerHTML = html;
                                    }
                                }

                                function gotoPage(page) {
                                    let totalPages = 1;
                                    if (isCardView) {
                                        totalPages = Math.ceil(filteredCards.length / pageSize) || 1;
                                    } else {
                                        totalPages = Math.ceil(filteredRows.length / pageSize) || 1;
                                    }
                                    if (page < 1) page = 1;
                                    if (page > totalPages) page = totalPages;
                                    currentPage = page;
                                    updatePagination();
                                    // Scroll to top of table or card grid
                                    const table = document.getElementById("paginationControls");
                                    const cards = document.getElementById("cardView");
                                    const target = isCardView ? cards : table;
                                    if (target) {
                                        target.scrollIntoView({ behavior: "smooth", block: "start" });
                                    }
                                }

                                function toggleView() {
                                    isCardView = !isCardView;
                                    localStorage.setItem('flipp_isCardView', isCardView ? '1' : '0');
                                    document.getElementById("tableView").style.display = isCardView ? "none" : "block";
                                    document.getElementById("cardView").style.display = isCardView ? "flex" : "none";
                                    const btn = document.getElementById("toggleViewBtn");
                                    btn.textContent = isCardView ? "Grid View" : "Card View";
                                    currentPage = 1;
                                    updatePagination();
                                }

                                window.addEventListener('DOMContentLoaded', function () {
                                    // Restore view mode from localStorage
                                    const stored = localStorage.getItem('flipp_isCardView');
                                    isCardView = stored === '1';
                                    document.getElementById("tableView").style.display = isCardView ? "none" : "block";
                                    document.getElementById("cardView").style.display = isCardView ? "flex" : "none";
                                    const btn = document.getElementById("toggleViewBtn");
                                    btn.textContent = isCardView ? "Grid View" : "Card View";
                                    updatePagination();
                                });
                                </script>
                                <div class="mt-3 text-end text-secondary">Total Results: <span class="fw-bold">@Model.Total</span>
                                </div>
                            }
                        </div>
                    </div>